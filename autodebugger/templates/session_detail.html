<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Session {{session.session_id if session else ''}}</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; background: #ffffff; color:#111827; }
    header { display:flex; gap:16px; align-items:center; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f7f7f7; text-align: left; }
    .filters { display:flex; gap:8px; align-items:center; }
    .pill { padding: 2px 8px; border-radius: 999px; background: #eee; }
    code { background:#f6f8fa; padding:2px 4px; border-radius:4px; }

    /* Visualizer styles */
    .viz-container { margin-top: 16px; display: grid; grid-template-columns: 1fr 2fr; gap: 16px; align-items: start; }
    .viz-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: linear-gradient(180deg, #ffffff, #fafafa); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .viz-title { font-weight: 600; margin-bottom: 8px; color: #374151; }
    .viz-meta { font-size: 12px; color: #6b7280; display:flex; gap:8px; flex-wrap: wrap; }
    .viz-legend { display:flex; gap:8px; margin-top: 8px; flex-wrap: wrap; }
    .legend-item { display:flex; gap:6px; align-items:center; font-size:12px; color:#4b5563; }
    .swatch { width:12px; height:12px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,0.08); }
    .swatch-changed { background:#d1fae5; border-color:#10b98133; }
    .swatch-removed { background:#fee2e2; border-color:#ef444433; }
    .swatch-unchanged { background:#f3f4f6; }
    .scopes-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .scope-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; background:#ffffff; }
    .scope-name { font-weight:600; color:#1f2937; margin-bottom:8px; font-size:13px; }
    .var-list { list-style:none; padding-left:0; margin:0; }
    .var-item { border: 1px dashed #e5e7eb; border-radius: 8px; padding: 6px 8px; margin: 6px 0; background: #fafafa; }
    .var-key { font-weight:600; color:#374151; }
    .var-val { color:#111827; word-break: break-word; }
    .badge { display:inline-block; font-size: 10px; padding: 2px 6px; border-radius:999px; margin-left:6px; }
    .badge-changed { background:#ecfdf5; color:#065f46; border:1px solid #10b98133; }
    .badge-removed { background:#fef2f2; color:#991b1b; border:1px solid #ef444433; }
    .faded { opacity: 0.65; }

    /* Quick highlights */
    .highlights { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#ffffff; font-size: 12px; box-shadow: 0 1px 1px rgba(0,0,0,0.03); }
    .chip .key { font-weight: 700; color:#111827; }
    .chip .val { color:#111827; max-width: 380px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chip.changed { border-color:#10b98133; background:#ecfdf5; }
    .chip.removed { border-color:#ef444433; background:#fef2f2; }
    .chip.added { border-color:#3b82f633; background:#eff6ff; }

    /* View options */
    .options { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .toggle { font-size:12px; padding: 6px 10px; border-radius: 8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .toggle.active { background:#111827; color:#fff; border-color:#111827; }

    /* Stepper */
    .stepper { display:flex; gap:8px; align-items:center; margin-top: 8px; flex-wrap: wrap; }
    .stepper .status { font-size: 12px; color:#6b7280; }

    /* Current line banner (above visualizer) */
    .current-line { 
      margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; 
      background: #fef3c7; /* amber-100 */ border: 1px solid #fde68a; /* amber-200 */
      text-align: center; color: #7c2d12; /* amber-900 */
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      /* Allow tooltip to overflow beyond banner */
      overflow: visible; position: relative; cursor: pointer;
    }
    .current-line .path { font-size: 12px; color: #6b7280; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .current-line .code { font-size: 13px; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Function tooltip */
    .fn-tooltip { position: absolute; transform: translate(-50%, 6px); left: 50%; z-index: 20; min-width: 320px; max-width: 70ch; white-space: pre-wrap; text-align: left; }
    .fn-tooltip .card { background: #ffffff; color: #111827; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .fn-tooltip .card .sig { font-weight: 700; color: #065f46; margin-bottom: 6px; }
    .fn-tooltip .card .body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 1.4; color: #1f2937; max-height: 40vh; overflow: auto; }

    /* Table interactivity */
    .table-container { max-height: 50vh; overflow: auto; margin-top: 12px; border: 1px solid #eee; border-radius: 8px; }
    .table-container table { border: none; margin: 0; width: 100%; }

    /* Dark mode overrides */
    .dark body { background:#0b1020; color:#e5e7eb; }
    .dark th, .dark td { border-color: #263041; }
    .dark th { background: #0f172a; color:#e2e8f0; }
    .dark .viz-card { background: linear-gradient(180deg, #0f172a, #0b1020); border-color:#263041; box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
    .dark .viz-title { color:#e5e7eb; }
    .dark .viz-meta { color:#94a3b8; }
    .dark .legend-item { color:#94a3b8; }
    .dark .var-item { background:#0f172a; border-color:#263041; }
    .dark .var-key { color:#e5e7eb; }
    .dark .var-val { color:#e5e7eb; }
    .dark .badge-changed { background:#052e2b; color:#a7f3d0; border-color:#10b98144; }
    .dark .badge-removed { background:#3f0d12; color:#fecaca; border-color:#ef444444; }
    .dark .table-container { border-color:#263041; }
    .dark tbody tr:hover { background:#0f172a; }
    .dark tbody tr.selected { background:#07263d; outline-color:#60a5fa; }
    .dark .current-line { background:#372f1b; border-color:#eab30855; color:#fde68a; }
    .dark .current-line .path { color:#fef08a; }
    .dark .current-line .code { color:#fef3c7; }
    .dark code { background:#111827; color:#e5e7eb; }
    .dark .chip { background:#1f2937; border-color:#374151; color:#e5e7eb; }
    .dark .chip .key { color:#f9fafb; }
    .dark .chip .val { color:#e5e7eb; }
    .dark .chip.changed { background:#0b2f26; border-color:#115e59; color:#a7f3d0; }
    .dark .chip.removed { background:#3f0d12; border-color:#7f1d1d; color:#fecaca; }
    .dark .fn-tooltip .card { background:#0b1220; color:#f8fafc; border-color:#334155; }
    .dark .fn-tooltip .card .sig { color:#34d399; }
    .dark .fn-tooltip .card .body { color:#e5e7eb; }
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: #fbfbfb; }
    tbody tr.selected { outline: 2px solid #60a5fa; outline-offset: -2px; background:#f0f9ff; }
  </style>
  <script>
    (function(){
      // basic prefers-color-scheme dark mode with toggle
      const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) document.documentElement.classList.add('dark');
    })();
  </script>
</head>
<body>
  <header>
    <a href="/">‚Üê Sessions</a>
    <h2>Session {{session.session_id}}</h2>
    <form method="post" action="/session/{{session.session_id}}/delete" onsubmit="return confirm('Delete session {{session.session_id}}? This cannot be undone.');" style="margin-left:auto;">
      <button type="submit">Delete</button>
    </form>
  </header>

  <div>
    <div>Entry: <code>{{session.file}}</code></div>
    <div>Language: {{session.language}}</div>
    <div>Lines: {{session.total_lines_executed}} | Errors: {{session.lines_with_errors}} | Crashes: {{session.total_crashes}}{% if session.size_bytes %} | Size: {{ (session.size_bytes // 1024) }} KB{% endif %}</div>
  </div>

  <form method="get" class="filters">
    <label>File:</label>
    <select name="file">
      <option value="">All</option>
      {% for f in files %}
      <option value="{{f}}" {% if selected_file==f %}selected{% endif %}>{{f}}</option>
      {% endfor %}
    </select>
    <label>Status:</label>
    <select name="status">
      <option value="">Any</option>
      <option value="success" {% if selected_status=='success' %}selected{% endif %}>success</option>
      <option value="error" {% if selected_status=='error' %}selected{% endif %}>error</option>
      <option value="warning" {% if selected_status=='warning' %}selected{% endif %}>warning</option>
    </select>
    <button type="submit">Filter</button>
  </form>

  <!-- Audio Controls and Keyboard Shortcuts -->
  <div style="background: #f0f9ff; border: 1px solid #60a5fa; border-radius: 8px; padding: 12px; margin: 16px 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h3 style="margin: 0; color: #1e40af;">Audio & Keyboard Controls</h3>
      <div style="display: flex; gap: 8px;">
        <button id="btn-play-pause" class="btn" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">‚ñ∂ Play Session</button>
        <button id="btn-stop" class="btn" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">‚ñ† Stop</button>
        <select id="speed-select" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e1;">
          <option value="slow">Slow</option>
          <option value="medium" selected>Medium</option>
          <option value="fast">Fast</option>
        </select>
      </div>
    </div>
    <div style="font-size: 13px; color: #475569; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
      <div><kbd>Space</kbd> Play/Pause current line</div>
      <div><kbd>‚Üë/‚Üì/Enter</kbd> Navigate (Shift+Enter = back)</div>
      <div><kbd>X</kbd> Show function code</div>
      <div><kbd>F</kbd> Speak function signature</div>
      <div><kbd>P</kbd> Explore function blocks</div>
      <div><kbd>V</kbd> Speak variables summary</div>
      <div><kbd>W</kbd> Explore variables interactively</div>
      <div><kbd>E</kbd> Explore changes</div>
      <div><kbd>S</kbd> Toggle speed (slow/med/fast)</div>
      <div><kbd>Esc</kbd> Stop audio</div>
    </div>
  </div>

  <!-- Function Code Modal -->
  <div id="function-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 80%; max-height: 80%; overflow: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 id="function-title" style="margin: 0;">Function Code</h3>
        <button onclick="closeFunctionModal()" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">‚úï Close (Q)</button>
      </div>
      <div style="margin-bottom: 12px;">
        <button onclick="speakFunction(false)" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">üîä Speak Signature (F)</button>
      </div>
      <pre id="function-code" style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px; line-height: 1.5; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; border: 1px solid #334155;"></pre>
      <div style="margin-top: 12px; padding: 8px; background: #eff6ff; border-radius: 6px;">
        <div style="font-size: 12px; color: #1e40af;">
          <strong>Shortcuts:</strong> F = Speak signature | Q/Esc = Close
        </div>
      </div>
    </div>
  </div>

  <!-- Variable Explorer Modal -->
  <div id="variable-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 70%; width: 600px; max-height: 80%; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">Variable Explorer</h3>
        <button id="close-var-modal-btn" onclick="closeVariableModal()" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">‚úï Close (Q)</button>
      </div>
      <div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
        <div style="font-size: 13px; color: #374151; font-weight: 600;">
          Page <span id="var-page-num">1</span> of <span id="var-page-total">1</span> | 
          Total variables: <span id="var-total-count">0</span>
        </div>
      </div>
      <div id="variable-list" style="max-height: 350px; overflow-y: auto; margin-bottom: 12px;"></div>
      <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border: 1px solid #3b82f6;">
        <div style="font-size: 13px; color: #1e40af; line-height: 1.6;">
          <strong>Controls:</strong><br>
          ‚Ä¢ Press <kbd>0-9</kbd> to select and hear variable by number<br>
          ‚Ä¢ <kbd>‚Üë/‚Üì</kbd> or <kbd>j/k</kbd> to navigate | <kbd>Enter</kbd> to select<br>
          ‚Ä¢ <kbd>n</kbd> Next page | <kbd>p</kbd> Previous page<br>
          ‚Ä¢ <kbd>q</kbd> or <kbd>Esc</kbd> to close explorer<br>
          ‚Ä¢ <kbd>r</kbd> Repeat last spoken variable
        </div>
      </div>
    </div>
  </div>
  
  <!-- Block Explorer Modal -->
  <div id="block-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 5%; left: 5%; right: 5%; bottom: 5%; background: white; border-radius: 12px; padding: 24px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">Function Block Explorer</h3>
        <button id="close-block-modal-btn" onclick="closeBlockModal()" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">‚úï Close (Q)</button>
      </div>
      <div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
        <div style="font-size: 13px; color: #374151; font-weight: 600;">
          Page <span id="block-page-num">1</span> of <span id="block-page-total">1</span> | 
          Total blocks: <span id="block-total-count">0</span>
        </div>
      </div>
      <div id="block-list" style="flex: 1; overflow-y: auto; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px;"></div>
      <div style="background: #ecfdf5; padding: 12px; border-radius: 6px; border: 1px solid #10b981;">
        <div style="font-size: 13px; color: #047857; line-height: 1.6;">
          <strong>Controls:</strong><br>
          ‚Ä¢ Press <kbd>0-9</kbd> to select and hear block by number<br>
          ‚Ä¢ <kbd>n</kbd> Next page | <kbd>p</kbd> Previous page<br>
          ‚Ä¢ <kbd>q</kbd> or <kbd>Esc</kbd> to close explorer<br>
          ‚Ä¢ <kbd>s</kbd> Change speech speed
        </div>
      </div>
    </div>
  </div>
  
  <!-- Changes Explorer Modal -->
  <div id="changes-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; max-width: 70%; width: 600px; max-height: 80%; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0;">Changes Explorer</h3>
        <button id="close-changes-modal-btn" onclick="closeChangesModal()" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">‚úï Close (Q)</button>
      </div>
      <div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin-bottom: 12px;">
        <div style="font-size: 13px; color: #374151; font-weight: 600;">
          Page <span id="changes-page-num">1</span> of <span id="changes-page-total">1</span> | 
          Total changes: <span id="changes-total-count">0</span>
        </div>
      </div>
      <div id="changes-list" style="max-height: 350px; overflow-y: auto; margin-bottom: 12px;"></div>
      <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #f59e0b;">
        <div style="font-size: 13px; color: #92400e; line-height: 1.6;">
          <strong>Controls:</strong><br>
          ‚Ä¢ Press <kbd>0-9</kbd> to select and hear change by number<br>
          ‚Ä¢ <kbd>‚Üë/‚Üì</kbd> or <kbd>j/k</kbd> to navigate | <kbd>Enter</kbd> to select<br>
          ‚Ä¢ <kbd>n</kbd> Next page | <kbd>p</kbd> Previous page<br>
          ‚Ä¢ <kbd>q</kbd> or <kbd>Esc</kbd> to close explorer<br>
          ‚Ä¢ <kbd>r</kbd> Repeat last spoken change
        </div>
      </div>
    </div>
  </div>

  <!-- Visualizer: updates when a row is clicked -->
  <div class="viz-container">
    <div class="viz-card">
      <div class="viz-title">Selected Line</div>
      <div id="viz-meta" class="viz-meta">
        <span>No row selected. Click a row below to visualize scope changes.</span>
      </div>
      <div class="viz-legend">
        <div class="legend-item"><span class="swatch swatch-changed"></span> changed / added</div>
        <div class="legend-item"><span class="swatch swatch-removed"></span> removed</div>
        <div class="legend-item"><span class="swatch swatch-unchanged"></span> unchanged (faded)</div>
      </div>
      <div class="options">
        <button class="toggle" id="opt-show-libs" title="Show library modules / types">Libraries/Types</button>
        <button class="toggle active" id="opt-show-scalars" title="Show simple scalars prominently">Scalars First</button>
        <button class="toggle" id="opt-show-long" title="Expand long text values by default">Expand Long Text</button>
      </div>
      <div class="stepper">
        <button class="toggle" id="step-prev">‚óÄÔ∏é Back</button>
        <button class="toggle" id="step-next">Step ‚ñ∂Ô∏é</button>
        <span id="stepper-status" class="status"></span>
      </div>
      <div style="margin-top:8px; font-weight:600; color:#374151;">Quick highlights</div>
      <div id="highlights" class="highlights"></div>
    </div>
    <div class="viz-card">
      <div class="viz-title">Scope Visualizer</div>
      <div id="current-line" class="current-line" title="Current file:line">
        ‚Äî
        <div id="fn-tooltip" class="fn-tooltip" style="display:none; pointer-events: none;"></div>
      </div>
      <div id="visualizer">
        <div class="faded" style="font-size:13px;">Awaiting selection‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="table-container">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>File</th>
        <th>Line</th>
        <th>Code</th>
        <th>Variables</th>
        <th>Status</th>
        <th>Error</th>
        <th>When</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reports %}
      <tr
        data-id='{{ r.id }}'
        data-file='{{ r.file }}'
        data-line='{{ r.line_number }}'
        data-code='{{ r.code }}'
        data-status='{{ r.status }}'
        data-variables='{{ r.variables | tojson }}'
        data-delta='{{ r.variables_delta | tojson }}'
        {% if r.function %}data-func='{{ r.function }}'{% endif %}
        {% if r.function_signature %}data-function_signature='{{ r.function_signature | replace("'", "&#39;") | replace('"', '&quot;') | replace("\n", "\\n") }}'{% endif %}
        {% if r.function_body %}data-function_body='{{ r.function_body | replace("'", "&#39;") | replace('"', '&quot;') | replace("\n", "\\n") }}'{% endif %}
      >
        <td>{{r.id}}</td>
        <td style="max-width: 360px; word-break: break-all;">{{r.file}}</td>
        <td>{{r.line_number}}</td>
        <td style="max-width: 420px; word-break: break-all;"><code>{{r.code}}</code></td>
        <td style="max-width: 420px; word-break: break-all;">
          {% if r.variables %}
            <details>
              <summary>view</summary>
              <pre style="white-space: pre-wrap;">{{ r.variables | tojson(indent=2) }}</pre>
            </details>
          {% endif %}
        </td>
        <td>
          {{r.status}}
          {% if r.variables_delta %}
            <details>
              <summary>delta</summary>
              <pre style="white-space: pre-wrap;">{{ r.variables_delta | tojson(indent=2) }}</pre>
            </details>
          {% endif %}
        </td>
        <td>{% if r.error_type %}{{r.error_type}}: {{r.error_message}}{% endif %}</td>
        <td>{{r.timestamp}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <script>
    // Global variables for table navigation
    let selected = null;
    let rows = [];
    let selectRow = null; // Will be defined inside IIFE
    
    (function() {
      const state = {
        showLibs: false,
        showScalarsFirst: true,
        expandLong: false,
        maxPreview: 120
      };

      function isObject(value) {
        return value && typeof value === 'object' && !Array.isArray(value);
      }

      function renderValue(value) {
        if (isObject(value)) return JSON.stringify(value);
        return String(value);
      }

      function isLikelyLibOrType(key, valueStr) {
        if (state.showLibs) return false;
        const k = (key || '').toString();
        const v = (valueStr || '').toString();
        if (/^__.*__$/.test(k)) return true; // dunder vars
        if (/^<module\s/.test(v)) return true;
        if (/^<class\s/.test(v)) return true;
        if (/^<function\s/.test(v)) return true;
        if (v.includes('typing.')) return true;
        if (v.includes("from '/") && v.includes('site-packages')) return true;
        if (/^<.* at 0x[0-9a-fA-F]+>$/.test(v)) return true;
        return false;
      }

      function isScalar(value) {
        return (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean');
      }

      function truncate(text, limit) {
        const t = String(text);
        if (state.expandLong) return t;
        if (t.length <= limit) return t;
        return t.slice(0, limit - 1) + '‚Ä¶';
      }

      function getPath(obj, path) {
        try {
          return path.reduce((acc, k) => (acc == null ? undefined : acc[k]), obj);
        } catch { return undefined; }
      }

      function collectFlatChanges(varsByScope, deltaByScope) {
        const results = [];
        const scopeNames = Array.from(new Set([...Object.keys(varsByScope||{}), ...Object.keys(deltaByScope||{})]));
        for (const scopeName of scopeNames) {
          const varsObj = (varsByScope && varsByScope[scopeName]) || {};
          const deltaObj = (deltaByScope && deltaByScope[scopeName]) || {};
          function walk(deltaNode, path) {
            for (const key of Object.keys(deltaNode)) {
              const val = deltaNode[key];
              const newPath = path.concat([key]);
              if (isObject(val)) {
                walk(val, newPath);
              } else {
                const currentVal = getPath(varsObj, newPath);
                results.push({ scopeName, keyPath: newPath, key: newPath.join('.'), value: currentVal, kind: (currentVal === undefined || currentVal === null) ? 'removed' : 'changed' });
              }
            }
          }
          walk(deltaObj, []);
        }
        return results;
      }

      function renderHighlights(variables, delta) {
        const container = document.getElementById('highlights');
        container.innerHTML = '';
        const changes = collectFlatChanges(variables, delta);
        if (changes.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'faded';
          empty.textContent = 'No changes.';
          container.appendChild(empty);
          return;
        }
        // Prefer scalars; limit to 8
        const preferred = changes.sort((a,b) => {
          const av = a.value, bv = b.value;
          const as = isScalar(av) ? 0 : 1;
          const bs = isScalar(bv) ? 0 : 1;
          return as - bs || a.key.length - b.key.length;
        }).slice(0, 8);
        for (const c of preferred) {
          const chip = document.createElement('div');
          chip.className = 'chip ' + (c.kind === 'removed' ? 'removed' : 'changed');
          chip.title = `${c.scopeName} ¬∑ ${c.key}`;
          const keyEl = document.createElement('span');
          keyEl.className = 'key';
          keyEl.textContent = c.key.split('.').slice(-1)[0] + ':';
          const valEl = document.createElement('span');
          valEl.className = 'val';
          const valText = isObject(c.value) ? '{‚Ä¶}' : renderValue(c.value);
          valEl.textContent = truncate(valText, state.maxPreview);
          chip.appendChild(keyEl);
          chip.appendChild(valEl);
          container.appendChild(chip);
        }
      }

      function buildVarTree(scopeName, dataObj, deltaObj) {
        const card = document.createElement('div');
        card.className = 'scope-card';
        const title = document.createElement('div');
        title.className = 'scope-name';
        title.textContent = scopeName;
        card.appendChild(title);

        const list = document.createElement('ul');
        list.className = 'var-list';

        // Filter and sort keys: scalars first when enabled
        const keysRaw = Object.keys(dataObj || {});
        const keys = keysRaw.filter(k => !isLikelyLibOrType(k, renderValue(dataObj[k]))).sort((a,b) => {
          if (!state.showScalarsFirst) return a.localeCompare(b);
          const as = isScalar(dataObj[a]) ? 0 : 1;
          const bs = isScalar(dataObj[b]) ? 0 : 1;
          return as - bs || a.localeCompare(b);
        });
        const deltaKeys = Object.keys(deltaObj || {});
        const allKeys = Array.from(new Set([...keys, ...deltaKeys])).sort();

        for (const key of allKeys) {
          const value = dataObj ? dataObj[key] : undefined;
          const delta = deltaObj ? deltaObj[key] : undefined;

          const li = document.createElement('li');
          li.className = 'var-item';

          const label = document.createElement('div');
          const keyEl = document.createElement('span');
          keyEl.className = 'var-key';
          keyEl.textContent = key;
          label.appendChild(keyEl);

          if (delta !== undefined) {
            const badge = document.createElement('span');
            if (delta === null || delta === undefined) {
              badge.className = 'badge badge-removed';
              badge.textContent = 'removed';
            } else if (isObject(delta)) {
              badge.className = 'badge badge-changed';
              badge.textContent = 'modified';
            } else {
              badge.className = 'badge badge-changed';
              // Heuristic: treat as added/changed
              badge.textContent = (key in (dataObj || {})) ? 'changed' : 'added';
            }
            label.appendChild(badge);
          } else {
            label.classList.add('faded');
          }

          li.appendChild(label);

          const val = document.createElement('div');
          val.className = 'var-val';

          if (isObject(value)) {
            // Summarize nested object
            const summary = document.createElement('div');
            const keysCount = Object.keys(value || {}).length;
            summary.textContent = `{object ¬∑ ${keysCount} keys}`;
            summary.className = 'faded';
            const details = document.createElement('details');
            const summaryEl = document.createElement('summary');
            summaryEl.textContent = 'expand';
            details.appendChild(summaryEl);
            details.appendChild(buildNestedList(value, isObject(delta) ? delta : {}));
            val.appendChild(summary);
            val.appendChild(details);
          } else {
            const text = renderValue(value);
            const span = document.createElement('span');
            span.textContent = truncate(text, state.maxPreview);
            span.title = text;
            val.appendChild(span);
          }
          li.appendChild(val);
          list.appendChild(li);
        }

        card.appendChild(list);
        return card;
      }

      function buildNestedList(obj, delta) {
        const innerList = document.createElement('ul');
        innerList.className = 'var-list';
        const keys = Object.keys(obj || {}).sort();
        const deltaKeys = Object.keys(delta || {});
        const allKeys = Array.from(new Set([...keys, ...deltaKeys])).sort();
        for (const key of allKeys) {
          const val = obj ? obj[key] : undefined;
          const d = delta ? delta[key] : undefined;

          const li = document.createElement('li');
          li.className = 'var-item';
          const header = document.createElement('div');
          const k = document.createElement('span');
          k.className = 'var-key';
          k.textContent = key;
          header.appendChild(k);

          if (d !== undefined) {
            const badge = document.createElement('span');
            if (d === null || d === undefined) {
              badge.className = 'badge badge-removed';
              badge.textContent = 'removed';
            } else if (isObject(d)) {
              badge.className = 'badge badge-changed';
              badge.textContent = 'modified';
            } else {
              badge.className = 'badge badge-changed';
              badge.textContent = (key in (obj || {})) ? 'changed' : 'added';
            }
            header.appendChild(badge);
          } else {
            header.classList.add('faded');
          }

          li.appendChild(header);
          const valEl = document.createElement('div');
          valEl.className = 'var-val';
          if (isObject(val)) {
            valEl.appendChild(buildNestedList(val, isObject(d) ? d : {}));
          } else {
            valEl.textContent = renderValue(val);
          }
          li.appendChild(valEl);
          innerList.appendChild(li);
        }
        return innerList;
      }

      function renderVisualizer(row) {
        const viz = document.getElementById('visualizer');
        const vizMeta = document.getElementById('viz-meta');
        if (!row) {
          viz.innerHTML = '<div class="faded" style="font-size:13px;">Awaiting selection‚Ä¶</div>';
          vizMeta.textContent = 'No row selected. Click a row below to visualize scope changes.';
          return;
        }

        // Meta panel
        const file = row.dataset.file;
        const line = row.dataset.line;
        const code = row.dataset.code;
        const status = row.dataset.status;
        vizMeta.innerHTML = '';
        const parts = [
          `<span><strong>File:</strong> <code>${file}</code></span>`,
          `<span><strong>Line:</strong> ${line}</span>`,
          `<span><strong>Status:</strong> ${status}</span>`,
        ];
        const codeEl = document.createElement('div');
        codeEl.style.marginTop = '6px';
        codeEl.innerHTML = `<code>${code}</code>`;
        vizMeta.innerHTML = parts.join(' \u2022 ');
        vizMeta.appendChild(codeEl);

        // Visualizer grid of scopes
        viz.innerHTML = '';
        const currentLineBanner = document.getElementById('current-line');
        if (currentLineBanner) {
          currentLineBanner.innerHTML = '';
          const pathEl = document.createElement('div');
          pathEl.className = 'path';
          const func = row.dataset.func;
          pathEl.textContent = func ? `${file}:${line} ‚Äî ${func}()` : `${file}:${line}`;
          pathEl.title = `${file}:${line}`;
          const codeEl2 = document.createElement('div');
          codeEl2.className = 'code';
          codeEl2.textContent = code;
          // Attach click on banner (orange/yellow bar) to toggle tooltip if available
          const sig = (row.getAttribute('data-function_signature') || '').replace(/\\n/g, '\n');
          const body = (row.getAttribute('data-function_body') || '').replace(/\\n/g, '\n');
          if (sig || body) {
            // Recreate tooltip each render to avoid stale references
            const tooltip = document.createElement('div');
            tooltip.id = 'fn-tooltip';
            tooltip.className = 'fn-tooltip';
            tooltip.style.display = 'none';
            tooltip.style.pointerEvents = 'none';
            const card = document.createElement('div');
            card.className = 'card';
            if (sig) {
              const s = document.createElement('div');
              s.className = 'sig';
              s.textContent = sig;
              card.appendChild(s);
            }
            if (body) {
              const b = document.createElement('pre');
              b.className = 'body';
              b.textContent = body;
              card.appendChild(b);
            }
            tooltip.appendChild(card);
            currentLineBanner.appendChild(tooltip);
            const toggle = () => {
              tooltip.style.display = (tooltip.style.display === 'none' || !tooltip.style.display) ? 'block' : 'none';
              if (tooltip.style.display === 'block') {
                tooltip.style.left = '50%';
              }
            };
            // Assign instead of addEventListener to avoid stacking
            currentLineBanner.onclick = (ev) => { ev.stopPropagation(); toggle(); };
            document.addEventListener('click', (ev) => {
              if (!currentLineBanner.contains(ev.target)) tooltip.style.display = 'none';
            });
          }
          currentLineBanner.appendChild(pathEl);
          currentLineBanner.appendChild(codeEl2);
        }
        const scopesGrid = document.createElement('div');
        scopesGrid.className = 'scopes-grid';

        let variables, delta;
        try {
          variables = JSON.parse(row.dataset.variables || '{}');
        } catch { variables = {}; }
        try {
          delta = JSON.parse(row.dataset.delta || '{}');
        } catch { delta = {}; }

        // Quick highlights from delta
        renderHighlights(variables, delta);

        const scopeNames = Array.from(new Set([...Object.keys(variables || {}), ...Object.keys(delta || {})])).sort();
        if (scopeNames.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'faded';
          empty.textContent = 'No variables captured.';
          viz.appendChild(empty);
          return;
        }

        for (const scopeName of scopeNames) {
          const sVars = variables ? variables[scopeName] : undefined;
          const sDelta = delta ? delta[scopeName] : undefined;
          scopesGrid.appendChild(buildVarTree(scopeName, sVars || {}, sDelta || {}));
        }

        viz.appendChild(scopesGrid);
      }

      // Hook up table row clicks
      const tbody = document.querySelector('tbody');
      const tableContainer = document.querySelector('.table-container');
      if (!tbody) return;
      // Use global variables
      rows = Array.from(tbody.querySelectorAll('tr'));
      function updateStepperStatus() {
        if (!selected) { document.getElementById('stepper-status').textContent = ''; return; }
        const idx = rows.indexOf(selected);
        if (idx >= 0) document.getElementById('stepper-status').textContent = `Row ${idx+1} of ${rows.length}`;
      }
      // Assign to global variable
      selectRow = function(tr) {
        if (!tr) return;
        if (selected) {
          selected.classList.remove('selected');
          selected.removeAttribute('tabindex');
        }
        selected = tr;
        tr.classList.add('selected');
        tr.setAttribute('tabindex', '0');
        tr.focus(); // Focus the row directly for keyboard navigation
        // Keep selection visible within the table container without moving the whole page
        if (tableContainer) {
          const rowTop = tr.offsetTop;
          const rowBottom = rowTop + tr.offsetHeight;
          const viewTop = tableContainer.scrollTop;
          const viewBottom = viewTop + tableContainer.clientHeight;
          const padding = 24;
          if (rowTop < viewTop) {
            tableContainer.scrollTo({ top: Math.max(0, rowTop - padding), behavior: 'smooth' });
          } else if (rowBottom > viewBottom) {
            tableContainer.scrollTo({ top: rowBottom - tableContainer.clientHeight + padding, behavior: 'smooth' });
          }
        }
        renderVisualizer(tr);
        updateStepperStatus();
      }
      tbody.addEventListener('click', function(e) {
        const tr = e.target && (e.target.closest('tr'));
        if (!tr) return;
        selectRow(tr);
      });

      // Option toggles
      const optLibs = document.getElementById('opt-show-libs');
      const optScalars = document.getElementById('opt-show-scalars');
      const optLong = document.getElementById('opt-show-long');
      function rerender() { if (selected) renderVisualizer(selected); }
      optLibs.addEventListener('click', () => { state.showLibs = !state.showLibs; optLibs.classList.toggle('active', state.showLibs); rerender(); });
      optScalars.addEventListener('click', () => { state.showScalarsFirst = !state.showScalarsFirst; optScalars.classList.toggle('active', state.showScalarsFirst); rerender(); });
      optLong.addEventListener('click', () => { state.expandLong = !state.expandLong; optLong.classList.toggle('active', state.expandLong); rerender(); });

      // Auto-select the first row if present and ensure focus
      const first = tbody.querySelector('tr');
      if (first) {
        selectRow(first);
        // Set focus to enable keyboard navigation with a small delay
        setTimeout(() => {
          if (tableContainer) {
            tableContainer.setAttribute('tabindex', '0'); // Make it focusable
            tableContainer.focus();
          } else {
            // Fallback to focusing the body
            window.focus();
            document.body.setAttribute('tabindex', '0');
            document.body.focus();
          }
          console.log('Focus set for keyboard navigation');
        }, 100);
      }

      // Stepper controls
      const btnPrev = document.getElementById('step-prev');
      const btnNext = document.getElementById('step-next');
      btnPrev.addEventListener('click', () => {
        if (!selected) return;
        const idx = rows.indexOf(selected);
        if (idx > 0) selectRow(rows[idx-1]);
      });
      btnNext.addEventListener('click', () => {
        if (!selected) return;
        const idx = rows.indexOf(selected);
        if (idx < rows.length - 1) selectRow(rows[idx+1]);
      });

      // Keep rows array in sync if table updates
      const observer = new MutationObserver(() => { rows = Array.from(tbody.querySelectorAll('tr')); updateStepperStatus(); });
      observer.observe(tbody, { childList: true, subtree: false });
      
      // ========== AUDIO AND KEYBOARD FUNCTIONALITY ==========
      const sessionId = '{{session.session_id}}';
      let isPlaying = false;
      let currentLineId = null;
      let currentVariables = {};
      let variableExplorerIndex = 0;
      let allVariables = [];
      let currentVarPage = 0;
      let varsPerPage = 10;
      let lastSpokenVariable = null;
      let variableExplorerMode = 'scopes'; // 'scopes' or 'variables'
      let selectedScope = null;
      
      // Changes explorer state
      let allChanges = [];
      let currentChangesPage = 0;
      let changesPerPage = 10;
      let lastSpokenChange = null;
      let changesExplorerIndex = 0;
      let changesExplorerMode = 'scopes'; // 'scopes' or 'changes'
      let selectedChangesScope = null;
      let changesData = {};
      
      // Audio controls
      const playPauseBtn = document.getElementById('btn-play-pause');
      const stopBtn = document.getElementById('btn-stop');
      const speedSelect = document.getElementById('speed-select');
      
      // Set TTS speed
      speedSelect.addEventListener('change', async () => {
        await fetch('/api/tts/speed', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({speed: speedSelect.value})
        });
      });
      
      // Play/Pause button
      playPauseBtn.addEventListener('click', () => {
        if (selected) {
          togglePlayCurrentLine();
        }
      });
      
      // Stop button
      stopBtn.addEventListener('click', stopAudio);
      
      async function stopAudio() {
        isPlaying = false;
        playPauseBtn.textContent = '‚ñ∂ Play Session';
        await fetch('/api/tts/stop', {method: 'POST'});
      }
      
      async function togglePlayCurrentLine() {
        if (!selected) return;
        
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        if (isPlaying) {
          await stopAudio();
        } else {
          isPlaying = true;
          playPauseBtn.textContent = '‚è∏ Pause';
          await speakLine(lineId);
        }
      }
      
      async function speakLine(lineId, speakScope = true) {
        currentLineId = lineId;
        await fetch(`/api/session/${sessionId}/line/${lineId}/speak`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({speak_scope: speakScope})
        });
      }
      
      async function showFunctionCode() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/function`);
        const data = await response.json();
        
        document.getElementById('function-title').textContent = data.name || 'Function Code';
        document.getElementById('function-code').textContent = data.body || data.sig || 'No function context available';
        document.getElementById('function-modal').style.display = 'block';
      }
      
      async function speakFunction(full = false) {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        await fetch(`/api/session/${sessionId}/line/${lineId}/function?speak=true&full=${full}`);
      }
      
      async function speakVariables(mode = 'summary') {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        await fetch(`/api/session/${sessionId}/line/${lineId}/variables?speak=true&mode=${mode}`);
      }
      
      async function exploreVariables() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/variables`);
        const data = await response.json();
        currentVariables = data.variables;
        
        // DON'T speak the summary yet - wait for user to select a scope
        
        // Reset state
        variableExplorerMode = 'scopes';
        selectedScope = null;
        currentVarPage = 0;
        variableExplorerIndex = 0;
        
        // Display the modal
        document.getElementById('variable-modal').style.display = 'block';
        displayVariableScopesOrVars();
        
        // Announce navigation instructions
        announceVariableScopeInstructions();
      }
      
      async function announceVariableScopeInstructions() {
        // Get available scopes
        const scopes = [];
        for (const [scopeName, scopeVars] of Object.entries(currentVariables)) {
          if (typeof scopeVars === 'object' && !scopeName.startsWith('_')) {
            const varCount = Object.keys(scopeVars).filter(k => !k.startsWith('_')).length;
            if (varCount > 0) {
              scopes.push(scopeName);
            }
          }
        }
        
        if (scopes.length === 0) {
          await fetch('/api/tts/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: "No local or global variables available.",
              interrupt: false
            })
          });
        } else {
          let instruction = "";
          scopes.forEach((scope, idx) => {
            if (idx > 0) instruction += " or ";
            const scopeLabel = scope.toLowerCase().includes('global') ? 'Global' : 'Local';
            instruction += `press ${idx} for ${scopeLabel}`;
          });
          instruction += ". Press Q to quit.";
          
          await fetch('/api/tts/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: instruction,
              interrupt: false
            })
          });
        }
      }
      
      function displayVariableScopesOrVars() {
        if (variableExplorerMode === 'scopes') {
          displayVariableScopes();
        } else {
          displayVariablePage();
        }
      }
      
      function displayVariableScopes() {
        const varList = document.getElementById('variable-list');
        varList.innerHTML = '';
        
        // Get available scopes
        const scopes = [];
        for (const [scopeName, scopeVars] of Object.entries(currentVariables)) {
          if (typeof scopeVars === 'object' && !scopeName.startsWith('_')) {
            const varCount = Object.keys(scopeVars).filter(k => !k.startsWith('_')).length;
            if (varCount > 0) {  // Only add scopes that have variables
              scopes.push({name: scopeName, count: varCount, vars: scopeVars});
            }
          }
        }
        
        // If no scopes available, close the modal
        if (scopes.length === 0) {
          document.getElementById('variable-modal').style.display = 'none';
          return;
        }
        
        // Update header
        document.getElementById('var-page-num').textContent = '1';
        document.getElementById('var-page-total').textContent = '1';
        document.getElementById('var-total-count').textContent = `${scopes.length} scopes`;
        
        // Display scopes
        scopes.forEach((scope, idx) => {
          const div = document.createElement('div');
          div.style.cssText = 'padding: 12px; margin: 6px 0; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; display: flex; align-items: center; background: #eff6ff;';
          div.dataset.scopeName = scope.name;
          div.dataset.index = idx;
          
          const numBadge = `<span style="display: inline-block; width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 12px; font-weight: bold; flex-shrink: 0;">${idx}</span>`;
          
          div.innerHTML = `
            ${numBadge}
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #1e40af; font-size: 15px;">${scope.name}</div>
              <div style="font-size: 13px; color: #3b82f6; margin-top: 2px;">${scope.count} variables</div>
            </div>
          `;
          
          div.onclick = () => selectScope(scope.name);
          varList.appendChild(div);
        });
        
        if (scopes.length > 0) {
          highlightVariableAtIndex(0);
        }
      }
      
      async function selectScope(scopeName) {
        selectedScope = scopeName;
        variableExplorerMode = 'variables';
        
        // Get variables for this scope
        allVariables = [];
        const scopeVars = currentVariables[scopeName];
        if (scopeVars && typeof scopeVars === 'object') {
          for (const [varName, varValue] of Object.entries(scopeVars)) {
            if (!varName.startsWith('_')) {
              allVariables.push({scope: scopeName, name: varName, value: varValue});
            }
          }
        }
        
        // Announce scope and count
        const totalPages = Math.ceil(allVariables.length / varsPerPage);
        let announcement = `${scopeName} scope. ${allVariables.length} variables.`;
        if (totalPages > 1) {
          announcement += ` Page 1 of ${totalPages}. Press N for next page, P for previous.`;
        }
        announcement += " Press 0 through 9 to hear a variable. Press B to go back to scopes.";
        
        await fetch('/api/tts/speak', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({text: announcement, interrupt: true})
        });
        
        // Reset pagination for variables
        currentVarPage = 0;
        variableExplorerIndex = 0;
        displayVariablePage();
      }
      
      function displayVariablePage() {
        const varList = document.getElementById('variable-list');
        varList.innerHTML = '';
        
        // Add back button if in variables mode
        if (selectedScope) {
          const backBtn = document.createElement('div');
          backBtn.style.cssText = 'padding: 8px; margin: 0 0 8px 0; background: #f3f4f6; border-radius: 6px; cursor: pointer; text-align: center; border: 1px solid #e5e7eb;';
          backBtn.innerHTML = `<strong>‚Üê Back to Scopes (B)</strong> | Current: ${selectedScope}`;
          backBtn.onclick = () => {
            variableExplorerMode = 'scopes';
            selectedScope = null;
            displayVariableScopesOrVars();
          };
          varList.appendChild(backBtn);
        }
        
        const startIdx = currentVarPage * varsPerPage;
        const endIdx = Math.min(startIdx + varsPerPage, allVariables.length);
        const pageVars = allVariables.slice(startIdx, endIdx);
        
        // Update pagination info
        const totalPages = Math.ceil(allVariables.length / varsPerPage);
        document.getElementById('var-page-num').textContent = currentVarPage + 1;
        document.getElementById('var-page-total').textContent = totalPages;
        document.getElementById('var-total-count').textContent = allVariables.length;
        
        pageVars.forEach((v, idx) => {
          const globalIdx = startIdx + idx;
          const displayNum = idx;  // 0-9 for current page
          const div = document.createElement('div');
          div.style.cssText = 'padding: 10px; margin: 6px 0; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; display: flex; align-items: center; background: white;';
          div.dataset.index = globalIdx;
          div.dataset.pageIndex = idx;
          div.dataset.varName = v.name;
          div.dataset.scope = v.scope;
          
          // Add number indicator
          const numBadge = `<span style="display: inline-block; width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 12px; font-weight: bold; flex-shrink: 0;">${displayNum}</span>`;
          
          // Format value preview
          let valuePreview = JSON.stringify(v.value);
          if (valuePreview.length > 80) {
            valuePreview = valuePreview.substring(0, 77) + '...';
          }
          
          div.innerHTML = `
            ${numBadge}
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #111827; font-size: 14px;">${v.name}</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                <span style="color: #3b82f6;">${v.scope}</span> ‚Ä¢ 
                <span style="font-family: monospace;">${valuePreview}</span>
              </div>
            </div>
          `;
          
          div.onclick = () => {
            highlightVariableAtIndex(idx);
            exploreVariable(v.scope, v.name);
          };
          varList.appendChild(div);
        });
        
        // Highlight first item on new page
        if (pageVars.length > 0) {
          highlightVariableAtIndex(0);
        }
      }
      
      function closeVariableModal() {
        document.getElementById('variable-modal').style.display = 'none';
        allVariables = [];
        currentVarPage = 0;
        variableExplorerIndex = 0;
        variableExplorerMode = 'scopes';
        selectedScope = null;
      }
      
      function highlightVariableAtIndex(pageIndex) {
        const items = document.querySelectorAll('#variable-list > div');
        items.forEach((item, idx) => {
          if (idx === pageIndex) {
            item.style.background = '#f0f9ff';
            item.style.borderColor = '#3b82f6';
            item.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
          } else {
            item.style.background = 'white';
            item.style.borderColor = '#e5e7eb';
            item.style.boxShadow = 'none';
          }
        });
        variableExplorerIndex = pageIndex;
      }
      
      function nextVariablePage() {
        const totalPages = Math.ceil(allVariables.length / varsPerPage);
        if (currentVarPage < totalPages - 1) {
          currentVarPage++;
          variableExplorerIndex = 0;
          displayVariablePage();
        }
      }
      
      function prevVariablePage() {
        if (currentVarPage > 0) {
          currentVarPage--;
          variableExplorerIndex = 0;
          displayVariablePage();
        }
      }
      
      async function exploreVariable(scope, varName) {
        if (!selected) return;
        const lineId = selected.dataset.id;
        
        // Store for repeat functionality
        lastSpokenVariable = {scope, varName, lineId};
        
        // Navigate to the variable in the scope
        const path = scope ? [scope] : [];
        
        // Use detailed mode to read complete structure like manual mode does
        await fetch(`/api/session/${sessionId}/line/${lineId}/explore`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            variable: varName,
            path: path,
            speak: true,
            is_changes: false,
            mode: 'detailed'  // Use the same detailed reading as manual mode
          })
        });
      }
      
      async function repeatLastVariable() {
        if (lastSpokenVariable) {
          await exploreVariable(lastSpokenVariable.scope, lastSpokenVariable.varName);
        }
      }
      
      // ========== CHANGES EXPLORER FUNCTIONS ==========
      async function exploreChanges() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/variables`);
        const data = await response.json();
        changesData = data.changes || {};
        
        // Check if there are any changes
        let hasChanges = false;
        for (const [key, value] of Object.entries(changesData)) {
          if (!key.startsWith('_') && typeof value === 'object' && Object.keys(value).length > 0) {
            hasChanges = true;
            break;
          }
        }
        
        if (!hasChanges) {
          // No changes - just speak it
          await fetch(`/api/session/${sessionId}/line/${lineId}/variables?speak=true&mode=changes`);
          return;
        }
        
        // DON'T speak the changes summary yet - wait for user to select a scope
        
        // Reset state
        changesExplorerMode = 'scopes';
        selectedChangesScope = null;
        currentChangesPage = 0;
        changesExplorerIndex = 0;
        
        // Display the modal
        document.getElementById('changes-modal').style.display = 'block';
        displayChangesScopesOrChanges();
        
        // Announce navigation instructions
        await announceChangesScopeInstructions();
      }
      
      async function announceChangesScopeInstructions() {
        // Get available scopes with changes
        const scopes = [];
        for (const [scopeName, scopeChanges] of Object.entries(changesData)) {
          if (typeof scopeChanges === 'object' && !scopeName.startsWith('_')) {
            const changeCount = Object.keys(scopeChanges).filter(k => !k.startsWith('_')).length;
            if (changeCount > 0) {
              scopes.push(scopeName);
            }
          }
        }
        
        if (scopes.length === 0) {
          await fetch('/api/tts/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: "No local or global changes available.",
              interrupt: false
            })
          });
        } else {
          let instruction = "";
          scopes.forEach((scope, idx) => {
            if (idx > 0) instruction += " or ";
            const scopeLabel = scope.toLowerCase().includes('global') ? 'Global' : 'Local';
            instruction += `press ${idx} for ${scopeLabel} changes`;
          });
          instruction += ". Press Q to quit.";
          
          await fetch('/api/tts/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: instruction,
              interrupt: false
            })
          });
        }
      }
      
      function displayChangesScopesOrChanges() {
        if (changesExplorerMode === 'scopes') {
          displayChangesScopes();
        } else {
          displayChangesPage();
        }
      }
      
      function displayChangesScopes() {
        const changesList = document.getElementById('changes-list');
        changesList.innerHTML = '';
        
        // Get available scopes with changes
        const scopes = [];
        for (const [scopeName, scopeChanges] of Object.entries(changesData)) {
          if (typeof scopeChanges === 'object' && !scopeName.startsWith('_')) {
            const changeCount = Object.keys(scopeChanges).filter(k => !k.startsWith('_')).length;
            if (changeCount > 0) {
              scopes.push({name: scopeName, count: changeCount, changes: scopeChanges});
            }
          }
        }
        
        // If no scopes available, close the modal
        if (scopes.length === 0) {
          document.getElementById('changes-modal').style.display = 'none';
          return;
        }
        
        // Update header
        document.getElementById('changes-page-num').textContent = '1';
        document.getElementById('changes-page-total').textContent = '1';
        document.getElementById('changes-total-count').textContent = `${scopes.length} scopes`;
        
        // Display scopes
        scopes.forEach((scope, idx) => {
          const div = document.createElement('div');
          div.style.cssText = 'padding: 12px; margin: 6px 0; border: 2px solid #f59e0b; border-radius: 8px; cursor: pointer; display: flex; align-items: center; background: #fef3c7;';
          div.dataset.scopeName = scope.name;
          div.dataset.index = idx;
          
          const numBadge = `<span style="display: inline-block; width: 24px; height: 24px; background: #f59e0b; color: white; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 12px; font-weight: bold; flex-shrink: 0;">${idx}</span>`;
          
          div.innerHTML = `
            ${numBadge}
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #92400e; font-size: 15px;">üîÑ ${scope.name}</div>
              <div style="font-size: 13px; color: #78350f; margin-top: 2px;">${scope.count} changes</div>
            </div>
          `;
          
          div.onclick = () => selectChangesScope(scope.name);
          changesList.appendChild(div);
        });
        
        if (scopes.length > 0) {
          highlightChangeAtIndex(0);
        }
      }
      
      async function selectChangesScope(scopeName) {
        selectedChangesScope = scopeName;
        changesExplorerMode = 'changes';
        
        // Get changes for this scope
        allChanges = [];
        const scopeChanges = changesData[scopeName];
        if (scopeChanges && typeof scopeChanges === 'object') {
          for (const [changeName, changeValue] of Object.entries(scopeChanges)) {
            if (!changeName.startsWith('_')) {
              allChanges.push({name: changeName, value: changeValue, scope: scopeName});
            }
          }
        }
        
        // Announce scope and count
        const totalPages = Math.ceil(allChanges.length / changesPerPage);
        let announcement = `${scopeName} scope. ${allChanges.length} changes.`;
        if (totalPages > 1) {
          announcement += ` Page 1 of ${totalPages}. Press N for next page, P for previous.`;
        }
        announcement += " Press 0 through 9 to hear a change. Press B to go back to scopes.";
        
        await fetch('/api/tts/speak', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({text: announcement, interrupt: true})
        });
        
        // Reset pagination for changes
        currentChangesPage = 0;
        changesExplorerIndex = 0;
        displayChangesPage();
      }
      
      function displayChangesPage() {
        const changesList = document.getElementById('changes-list');
        changesList.innerHTML = '';
        
        // Add back button if in changes mode
        if (selectedChangesScope) {
          const backBtn = document.createElement('div');
          backBtn.style.cssText = 'padding: 8px; margin: 0 0 8px 0; background: #fef3c7; border-radius: 6px; cursor: pointer; text-align: center; border: 1px solid #fbbf24;';
          backBtn.innerHTML = `<strong>‚Üê Back to Scopes (B)</strong> | Current: ${selectedChangesScope}`;
          backBtn.onclick = () => {
            changesExplorerMode = 'scopes';
            selectedChangesScope = null;
            displayChangesScopesOrChanges();
          };
          changesList.appendChild(backBtn);
        }
        
        const startIdx = currentChangesPage * changesPerPage;
        const endIdx = Math.min(startIdx + changesPerPage, allChanges.length);
        const pageChanges = allChanges.slice(startIdx, endIdx);
        
        // Update pagination info
        const totalPages = Math.ceil(allChanges.length / changesPerPage);
        document.getElementById('changes-page-num').textContent = currentChangesPage + 1;
        document.getElementById('changes-page-total').textContent = totalPages;
        document.getElementById('changes-total-count').textContent = allChanges.length;
        
        pageChanges.forEach((change, idx) => {
          const displayNum = idx;
          const div = document.createElement('div');
          div.style.cssText = 'padding: 10px; margin: 6px 0; border: 2px solid #fbbf24; border-radius: 8px; cursor: pointer; display: flex; align-items: center; background: #fffbeb;';
          div.dataset.index = startIdx + idx;
          div.dataset.pageIndex = idx;
          div.dataset.changeName = change.name;
          
          // Add number indicator
          const numBadge = `<span style="display: inline-block; width: 24px; height: 24px; background: #f59e0b; color: white; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 12px; font-weight: bold; flex-shrink: 0;">${displayNum}</span>`;
          
          // Format value preview
          let valuePreview = JSON.stringify(change.value);
          if (valuePreview.length > 80) {
            valuePreview = valuePreview.substring(0, 77) + '...';
          }
          
          // Change indicator
          const changeIcon = 'üîÑ';
          
          div.innerHTML = `
            ${numBadge}
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #92400e; font-size: 14px;">
                ${changeIcon} ${change.name}
              </div>
              <div style="font-size: 12px; color: #78350f; margin-top: 2px;">
                <span style="font-family: monospace;">${valuePreview}</span>
              </div>
            </div>
          `;
          
          div.onclick = () => {
            highlightChangeAtIndex(idx);
            exploreChange(change.name, change.value, change.scope);
          };
          changesList.appendChild(div);
        });
        
        // Highlight first item on new page
        if (pageChanges.length > 0) {
          highlightChangeAtIndex(0);
        }
      }
      
      function closeChangesModal() {
        document.getElementById('changes-modal').style.display = 'none';
        allChanges = [];
        currentChangesPage = 0;
        changesExplorerIndex = 0;
        changesExplorerMode = 'scopes';
        selectedChangesScope = null;
      }
      
      function highlightChangeAtIndex(pageIndex) {
        const items = document.querySelectorAll('#changes-list > div');
        items.forEach((item, idx) => {
          if (idx === pageIndex) {
            item.style.background = '#fef3c7';
            item.style.borderColor = '#f59e0b';
            item.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.2)';
          } else {
            item.style.background = '#fffbeb';
            item.style.borderColor = '#fbbf24';
            item.style.boxShadow = 'none';
          }
        });
        changesExplorerIndex = pageIndex;
      }
      
      function nextChangesPage() {
        const totalPages = Math.ceil(allChanges.length / changesPerPage);
        if (currentChangesPage < totalPages - 1) {
          currentChangesPage++;
          changesExplorerIndex = 0;
          displayChangesPage();
        }
      }
      
      function prevChangesPage() {
        if (currentChangesPage > 0) {
          currentChangesPage--;
          changesExplorerIndex = 0;
          displayChangesPage();
        }
      }
      
      async function exploreChange(changeName, changeValue, scope) {
        if (!selected) return;
        const lineId = selected.dataset.id;
        
        // Store for repeat functionality
        lastSpokenChange = {name: changeName, value: changeValue, scope: scope, lineId};
        
        // Use detailed mode to read complete structure like manual mode does
        await fetch(`/api/session/${sessionId}/line/${lineId}/explore`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            variable: changeName,
            path: scope ? [scope] : [],  // Include scope in path if available
            is_changes: true,  // Flag to indicate we're exploring changes
            speak: true,
            mode: 'detailed'  // Use the same detailed reading as manual mode
          })
        });
      }
      
      async function repeatLastChange() {
        if (lastSpokenChange) {
          await exploreChange(lastSpokenChange.name, lastSpokenChange.value, lastSpokenChange.scope);
        }
      }
      
      // ========== BLOCK EXPLORER FUNCTIONS ==========
      let currentBlockPage = 0;
      let totalBlockPages = 1;
      let currentBlocks = [];
      
      async function exploreFunctionBlocks() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        if (!lineId) return;
        
        // Get blocks with announcement
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/blocks?announce=true`);
        const data = await response.json();
        
        if (data.error) {
          await fetch('/api/tts/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: data.error, interrupt: true})
          });
          return;
        }
        
        currentBlocks = data.blocks;
        currentBlockPage = data.current_page;
        totalBlockPages = data.total_pages;
        
        // Display modal
        document.getElementById('block-modal').style.display = 'block';
        displayBlocksPage();
      }
      
      function displayBlocksPage() {
        const blockList = document.getElementById('block-list');
        blockList.innerHTML = '';
        
        // Update header
        document.getElementById('block-page-num').textContent = currentBlockPage + 1;
        document.getElementById('block-page-total').textContent = totalBlockPages;
        document.getElementById('block-total-count').textContent = currentBlocks.length;
        
        // Display blocks with full code visible
        currentBlocks.forEach((block, idx) => {
          const div = document.createElement('div');
          div.style.cssText = 'margin: 8px 0; border: 2px solid #10b981; border-radius: 8px; overflow: hidden;';
          div.dataset.index = idx;
          
          // Header with number badge
          const header = document.createElement('div');
          header.style.cssText = 'padding: 8px 12px; background: #ecfdf5; border-bottom: 1px solid #10b981; display: flex; align-items: center; cursor: pointer;';
          header.innerHTML = `
            <span style="display: inline-block; width: 28px; height: 28px; background: #10b981; color: white; border-radius: 50%; text-align: center; line-height: 28px; margin-right: 12px; font-weight: bold; font-size: 14px;">${idx}</span>
            <span style="font-weight: 600; color: #047857;">Block ${idx}</span>
          `;
          header.onclick = () => selectBlock(idx);
          
          // Code content
          const codeDiv = document.createElement('div');
          codeDiv.style.cssText = 'padding: 12px; background: #f0fdf4; font-family: monospace; font-size: 12px; color: #1f2937; white-space: pre-wrap; word-break: break-word; line-height: 1.5;';
          codeDiv.textContent = block.full_text;
          
          div.appendChild(header);
          div.appendChild(codeDiv);
          blockList.appendChild(div);
        });
        
        // Highlight first block
        if (currentBlocks.length > 0) {
          highlightBlockAtIndex(0);
        }
      }
      
      function highlightBlockAtIndex(index) {
        const items = document.querySelectorAll('#block-list > div');
        items.forEach((item, idx) => {
          if (idx === index) {
            item.style.borderColor = '#059669';
            item.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.3)';
            // Highlight the header more prominently
            const header = item.querySelector('div:first-child');
            if (header) {
              header.style.background = '#10b981';
              header.style.color = 'white';
              const blockLabel = header.querySelector('span:last-child');
              if (blockLabel) blockLabel.style.color = 'white';
            }
          } else {
            item.style.borderColor = '#10b981';
            item.style.boxShadow = 'none';
            // Reset header
            const header = item.querySelector('div:first-child');
            if (header) {
              header.style.background = '#ecfdf5';
              header.style.color = 'inherit';
              const blockLabel = header.querySelector('span:last-child');
              if (blockLabel) blockLabel.style.color = '#047857';
            }
          }
        });
      }
      
      async function selectBlock(index) {
        if (!selected) return;
        const lineId = selected.dataset.id;
        
        // Send selection to backend
        await fetch(`/api/session/${sessionId}/line/${lineId}/blocks`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'select',
            index: index
          })
        });
        
        highlightBlockAtIndex(index);
      }
      
      async function nextBlockPage() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/blocks`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'next'})
        });
        
        if (response.ok) {
          const data = await response.json();
          currentBlocks = data.blocks;
          currentBlockPage = data.current_page;
          displayBlocksPage();
        }
      }
      
      async function prevBlockPage() {
        if (!selected) return;
        const lineId = selected.dataset.id;
        
        const response = await fetch(`/api/session/${sessionId}/line/${lineId}/blocks`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'previous'})
        });
        
        if (response.ok) {
          const data = await response.json();
          currentBlocks = data.blocks;
          currentBlockPage = data.current_page;
          displayBlocksPage();
        }
      }
      
      function closeBlockModal() {
        document.getElementById('block-modal').style.display = 'none';
        currentBlocks = [];
        currentBlockPage = 0;
      }
      
      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }
      
      function closeFunctionModal() {
        document.getElementById('function-modal').style.display = 'none';
      }
      
      // Keyboard shortcuts
      document.addEventListener('keydown', async (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
          return;
        }
        
        // Debug log
        console.log(`Key pressed: ${e.key}, selected:`, selected ? 'yes' : 'no', 'rows:', rows.length);
        
        // Speed control - always available
        if (e.key.toLowerCase() === 's' && !e.shiftKey) {
          e.preventDefault();
          const speeds = ['slow', 'medium', 'fast'];
          const currentIndex = speeds.indexOf(speedSelect.value);
          const nextIndex = (currentIndex + 1) % speeds.length;
          speedSelect.value = speeds[nextIndex];
          speedSelect.dispatchEvent(new Event('change'));
          // Visual feedback
          const speedText = speedSelect.value.charAt(0).toUpperCase() + speedSelect.value.slice(1);
          console.log(`Speed changed to: ${speedText}`);
          return;
        }
        
        // Check if any modal is open
        const modalOpen = document.getElementById('function-modal').style.display === 'block' ||
                         document.getElementById('variable-modal').style.display === 'block' ||
                         document.getElementById('changes-modal').style.display === 'block' ||
                         document.getElementById('block-modal').style.display === 'block';
        
        // Navigation
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          const idx = rows.indexOf(selected);
          if (idx > 0) selectRow(rows[idx - 1]);
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          const idx = rows.indexOf(selected);
          if (idx < rows.length - 1) selectRow(rows[idx + 1]);
        } else if (e.key === 'Enter' && !modalOpen) {
          e.preventDefault();
          const idx = rows.indexOf(selected);
          if (e.shiftKey) {
            // Shift+Enter goes backwards
            if (idx > 0) selectRow(rows[idx - 1]);
          } else {
            // Enter moves to next row only when no modal is open
            if (idx < rows.length - 1) selectRow(rows[idx + 1]);
          }
        }
        
        // Audio controls
        else if (e.key === ' ') {
          e.preventDefault();
          togglePlayCurrentLine();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          stopAudio();
          closeFunctionModal();
          closeVariableModal();
          closeChangesModal();
          closeBlockModal();
        }
        
        // Function exploration
        else if (e.key.toLowerCase() === 'x') {
          e.preventDefault();
          showFunctionCode();
        } else if (e.key.toLowerCase() === 'f') {
          e.preventDefault();
          speakFunction(false);
        } else if (e.key.toLowerCase() === 'p') {
          e.preventDefault();
          exploreFunctionBlocks();  // Changed: 'p' now opens block explorer
        }
        
        // Variable exploration
        else if (e.key.toLowerCase() === 'v') {
          e.preventDefault();
          speakVariables('summary');
        } else if (e.key.toLowerCase() === 'w') {
          e.preventDefault();
          exploreVariables();
        } else if (e.key.toLowerCase() === 'e') {
          e.preventDefault();
          exploreChanges();
        }
        
        // Function modal navigation
        if (document.getElementById('function-modal').style.display === 'block') {
          if (e.key.toLowerCase() === 'f') {
            e.preventDefault();
            speakFunction(false);
          } else if (e.key === 'q' || e.key === 'Escape') {
            e.preventDefault();
            closeFunctionModal();
          }
        }
        
        // Changes explorer navigation
        if (document.getElementById('changes-modal').style.display === 'block') {
          const items = document.querySelectorAll('#changes-list > div:not(:first-child)'); // Exclude back button if present
          
          // Back to scopes
          if (e.key.toLowerCase() === 'b' && changesExplorerMode === 'changes') {
            e.preventDefault();
            changesExplorerMode = 'scopes';
            selectedChangesScope = null;
            displayChangesScopesOrChanges();
            return;
          }
          
          // Number keys 0-9 for direct selection
          if (e.key >= '0' && e.key <= '9') {
            e.preventDefault();
            const num = parseInt(e.key);
            
            if (changesExplorerMode === 'scopes') {
              // Select scope
              const scopeItems = document.querySelectorAll('#changes-list > div');
              if (num < scopeItems.length) {
                const item = scopeItems[num];
                selectChangesScope(item.dataset.scopeName);
              }
            } else {
              // Select change (accounting for back button)
              const changeItems = document.querySelectorAll('#changes-list > div:not(:first-child)');
              if (num < changeItems.length) {
                const change = allChanges[currentChangesPage * changesPerPage + num];
                if (change) {
                  highlightChangeAtIndex(num);
                  exploreChange(change.name, change.value, change.scope);
                }
              }
            }
          }
          // Navigation keys
          else if ((e.key === 'ArrowUp' || e.key === 'k') && changesExplorerIndex > 0) {
            e.preventDefault();
            highlightChangeAtIndex(changesExplorerIndex - 1);
          } else if ((e.key === 'ArrowDown' || e.key === 'j') && changesExplorerIndex < items.length - 1) {
            e.preventDefault();
            highlightChangeAtIndex(changesExplorerIndex + 1);
          }
          // Select current item
          else if (e.key === 'Enter') {
            e.preventDefault();
            if (changesExplorerMode === 'scopes') {
              const scopeItems = document.querySelectorAll('#changes-list > div');
              if (scopeItems[changesExplorerIndex]) {
                selectChangesScope(scopeItems[changesExplorerIndex].dataset.scopeName);
              }
            } else {
              const change = allChanges[currentChangesPage * changesPerPage + changesExplorerIndex];
              if (change) {
                exploreChange(change.name, change.value, change.scope);
              }
            }
          }
          // Pagination
          else if (e.key === 'n') {
            e.preventDefault();
            nextChangesPage();
          } else if (e.key === 'p' && e.key !== 'P') {
            e.preventDefault();
            prevChangesPage();
          }
          // Close modal
          else if (e.key === 'q' || e.key === 'Escape') {
            e.preventDefault();
            closeChangesModal();
          }
          // Repeat last change
          else if (e.key === 'r') {
            e.preventDefault();
            repeatLastChange();
          }
        }
        
        // Block explorer navigation
        if (document.getElementById('block-modal').style.display === 'block') {
          // Number keys 0-9 for block selection
          if (e.key >= '0' && e.key <= '9') {
            e.preventDefault();
            const num = parseInt(e.key);
            if (num < currentBlocks.length) {
              selectBlock(num);
            }
          }
          // Navigation
          else if (e.key === 'n') {
            e.preventDefault();
            nextBlockPage();
          } else if (e.key === 'p' && !e.shiftKey) {
            e.preventDefault();
            prevBlockPage();
          }
          // Speed control
          else if (e.key === 's') {
            e.preventDefault();
            // Change speed
            const speeds = ['slow', 'medium', 'fast'];
            const currentIdx = speeds.indexOf(speedSelect.value);
            const nextIdx = (currentIdx + 1) % speeds.length;
            speedSelect.value = speeds[nextIdx];
            speedSelect.dispatchEvent(new Event('change'));
          }
          // Close modal
          else if (e.key === 'q' || e.key === 'Escape') {
            e.preventDefault();
            closeBlockModal();
          }
        }
        
        // Variable explorer navigation
        if (document.getElementById('variable-modal').style.display === 'block') {
          const items = document.querySelectorAll('#variable-list > div:not(:first-child)'); // Exclude back button if present
          
          // Back to scopes
          if (e.key.toLowerCase() === 'b' && variableExplorerMode === 'variables') {
            e.preventDefault();
            variableExplorerMode = 'scopes';
            selectedScope = null;
            displayVariableScopesOrVars();
            return;
          }
          
          // Number keys 0-9 for direct selection
          if (e.key >= '0' && e.key <= '9') {
            e.preventDefault();
            const num = parseInt(e.key);
            
            if (variableExplorerMode === 'scopes') {
              // Select scope
              const scopeItems = document.querySelectorAll('#variable-list > div');
              if (num < scopeItems.length) {
                const item = scopeItems[num];
                selectScope(item.dataset.scopeName);
              }
            } else {
              // Select variable (accounting for back button)
              const varItems = document.querySelectorAll('#variable-list > div:not(:first-child)');
              if (num < varItems.length) {
                const item = varItems[num];
                highlightVariableAtIndex(num);
                exploreVariable(item.dataset.scope, item.dataset.varName);
              }
            }
          }
          // Navigation keys
          else if ((e.key === 'ArrowUp' || e.key === 'k') && variableExplorerIndex > 0) {
            e.preventDefault();
            highlightVariableAtIndex(variableExplorerIndex - 1);
          } else if ((e.key === 'ArrowDown' || e.key === 'j') && variableExplorerIndex < items.length - 1) {
            e.preventDefault();
            highlightVariableAtIndex(variableExplorerIndex + 1);
          }
          // Select current item
          else if (e.key === 'Enter' && items[variableExplorerIndex]) {
            e.preventDefault();
            const item = items[variableExplorerIndex];
            exploreVariable(item.dataset.scope, item.dataset.varName);
          }
          // Pagination
          else if (e.key === 'n') {
            e.preventDefault();
            nextVariablePage();
          } else if (e.key === 'p' && e.key !== 'P') {
            e.preventDefault();
            prevVariablePage();
          }
          // Close modal
          else if (e.key === 'q' || e.key === 'Escape') {
            e.preventDefault();
            closeVariableModal();
          }
          // Repeat last variable
          else if (e.key === 'r') {
            e.preventDefault();
            repeatLastVariable();
          }
        }
      });
      
      // Update selectRow to store line ID
      const originalSelectRow = selectRow;
      selectRow = function(row) {
        originalSelectRow(row);
        if (row) {
          // Extract line ID from the row (assuming it's in the first cell or data attribute)
          const cells = row.querySelectorAll('td');
          if (cells.length > 0) {
            row.dataset.id = cells[0].textContent.trim();
          }
        }
      };
    })();
    
    // Ensure keyboard shortcuts work on page load
    window.addEventListener('DOMContentLoaded', () => {
      // Force focus and simulate a click to activate keyboard handlers
      setTimeout(() => {
        const tableContainer = document.querySelector('.table-container');
        const firstRow = document.querySelector('tbody tr');
        
        if (firstRow && !selected) {
          // If no row is selected yet, select the first one
          selectRow(firstRow);
        }
        
        if (tableContainer) {
          tableContainer.setAttribute('tabindex', '0');
          tableContainer.focus();
          // Simulate a click to ensure focus is properly set
          tableContainer.click();
          console.log('Page loaded - focus set and clicked table container');
        }
        
        // Also try focusing the document body as a fallback
        document.body.setAttribute('tabindex', '0');
        document.body.focus();
      }, 300);
    });
  </script>
</body>
</html>
