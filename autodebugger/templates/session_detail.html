<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Session {{session.session_id if session else ''}}</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:center; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f7f7f7; text-align: left; }
    .filters { display:flex; gap:8px; align-items:center; }
    .pill { padding: 2px 8px; border-radius: 999px; background: #eee; }
    code { background:#f6f8fa; padding:2px 4px; border-radius:4px; }

    /* Visualizer styles */
    .viz-container { margin-top: 16px; display: grid; grid-template-columns: 1fr 2fr; gap: 16px; align-items: start; }
    .viz-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: linear-gradient(180deg, #ffffff, #fafafa); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .viz-title { font-weight: 600; margin-bottom: 8px; color: #374151; }
    .viz-meta { font-size: 12px; color: #6b7280; display:flex; gap:8px; flex-wrap: wrap; }
    .viz-legend { display:flex; gap:8px; margin-top: 8px; flex-wrap: wrap; }
    .legend-item { display:flex; gap:6px; align-items:center; font-size:12px; color:#4b5563; }
    .swatch { width:12px; height:12px; border-radius:3px; display:inline-block; border:1px solid rgba(0,0,0,0.08); }
    .swatch-changed { background:#d1fae5; border-color:#10b98133; }
    .swatch-removed { background:#fee2e2; border-color:#ef444433; }
    .swatch-unchanged { background:#f3f4f6; }
    .scopes-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .scope-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; background:#ffffff; }
    .scope-name { font-weight:600; color:#1f2937; margin-bottom:8px; font-size:13px; }
    .var-list { list-style:none; padding-left:0; margin:0; }
    .var-item { border: 1px dashed #e5e7eb; border-radius: 8px; padding: 6px 8px; margin: 6px 0; background: #fafafa; }
    .var-key { font-weight:600; color:#374151; }
    .var-val { color:#111827; word-break: break-word; }
    .badge { display:inline-block; font-size: 10px; padding: 2px 6px; border-radius:999px; margin-left:6px; }
    .badge-changed { background:#ecfdf5; color:#065f46; border:1px solid #10b98133; }
    .badge-removed { background:#fef2f2; color:#991b1b; border:1px solid #ef444433; }
    .faded { opacity: 0.65; }

    /* Quick highlights */
    .highlights { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#ffffff; font-size: 12px; box-shadow: 0 1px 1px rgba(0,0,0,0.03); }
    .chip .key { font-weight: 700; color:#111827; }
    .chip .val { color:#111827; max-width: 380px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chip.changed { border-color:#10b98133; background:#ecfdf5; }
    .chip.removed { border-color:#ef444433; background:#fef2f2; }
    .chip.added { border-color:#3b82f633; background:#eff6ff; }

    /* View options */
    .options { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .toggle { font-size:12px; padding: 6px 10px; border-radius: 8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .toggle.active { background:#111827; color:#fff; border-color:#111827; }

    /* Stepper */
    .stepper { display:flex; gap:8px; align-items:center; margin-top: 8px; flex-wrap: wrap; }
    .stepper .status { font-size: 12px; color:#6b7280; }

    /* Current line banner (above visualizer) */
    .current-line { 
      margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; 
      background: #fef3c7; /* amber-100 */ border: 1px solid #fde68a; /* amber-200 */
      text-align: center; color: #7c2d12; /* amber-900 */
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow: hidden;
    }
    .current-line .path { font-size: 12px; color: #6b7280; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .current-line .code { font-size: 13px; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Table interactivity */
    .table-container { max-height: 50vh; overflow: auto; margin-top: 12px; border: 1px solid #eee; border-radius: 8px; }
    .table-container table { border: none; margin: 0; width: 100%; }
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: #fbfbfb; }
    tbody tr.selected { outline: 2px solid #60a5fa; outline-offset: -2px; background:#f0f9ff; }
  </style>
</head>
<body>
  <header>
    <a href="/">← Sessions</a>
    <h2>Session {{session.session_id}}</h2>
  </header>

  <div>
    <div>Entry: <code>{{session.file}}</code></div>
    <div>Language: {{session.language}}</div>
    <div>Lines: {{session.total_lines_executed}} | Errors: {{session.lines_with_errors}} | Crashes: {{session.total_crashes}}</div>
  </div>

  <form method="get" class="filters">
    <label>File:</label>
    <select name="file">
      <option value="">All</option>
      {% for f in files %}
      <option value="{{f}}" {% if selected_file==f %}selected{% endif %}>{{f}}</option>
      {% endfor %}
    </select>
    <label>Status:</label>
    <select name="status">
      <option value="">Any</option>
      <option value="success" {% if selected_status=='success' %}selected{% endif %}>success</option>
      <option value="error" {% if selected_status=='error' %}selected{% endif %}>error</option>
      <option value="warning" {% if selected_status=='warning' %}selected{% endif %}>warning</option>
    </select>
    <button type="submit">Filter</button>
  </form>

  <!-- Visualizer: updates when a row is clicked -->
  <div class="viz-container">
    <div class="viz-card">
      <div class="viz-title">Selected Line</div>
      <div id="viz-meta" class="viz-meta">
        <span>No row selected. Click a row below to visualize scope changes.</span>
      </div>
      <div class="viz-legend">
        <div class="legend-item"><span class="swatch swatch-changed"></span> changed / added</div>
        <div class="legend-item"><span class="swatch swatch-removed"></span> removed</div>
        <div class="legend-item"><span class="swatch swatch-unchanged"></span> unchanged (faded)</div>
      </div>
      <div class="options">
        <button class="toggle" id="opt-show-libs" title="Show library modules / types">Libraries/Types</button>
        <button class="toggle active" id="opt-show-scalars" title="Show simple scalars prominently">Scalars First</button>
        <button class="toggle" id="opt-show-long" title="Expand long text values by default">Expand Long Text</button>
      </div>
      <div class="stepper">
        <button class="toggle" id="step-prev">◀︎ Back</button>
        <button class="toggle" id="step-next">Step ▶︎</button>
        <span id="stepper-status" class="status"></span>
      </div>
      <div style="margin-top:8px; font-weight:600; color:#374151;">Quick highlights</div>
      <div id="highlights" class="highlights"></div>
    </div>
    <div class="viz-card">
      <div class="viz-title">Scope Visualizer</div>
      <div id="current-line" class="current-line" title="Current file:line">—</div>
      <div id="visualizer">
        <div class="faded" style="font-size:13px;">Awaiting selection…</div>
      </div>
    </div>
  </div>

  <div class="table-container">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>File</th>
        <th>Line</th>
        <th>Code</th>
        <th>Variables</th>
        <th>Status</th>
        <th>Error</th>
        <th>When</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reports %}
      <tr
        data-id='{{ r.id }}'
        data-file='{{ r.file }}'
        data-line='{{ r.line_number }}'
        data-code='{{ r.code }}'
        data-status='{{ r.status }}'
        data-variables='{{ r.variables | tojson }}'
        data-delta='{{ r.variables_delta | tojson }}'
        {% if r.function %}data-func='{{ r.function }}'{% endif %}
      >
        <td>{{r.id}}</td>
        <td style="max-width: 360px; word-break: break-all;">{{r.file}}</td>
        <td>{{r.line_number}}</td>
        <td style="max-width: 420px; word-break: break-all;"><code>{{r.code}}</code></td>
        <td style="max-width: 420px; word-break: break-all;">
          {% if r.variables %}
            <details>
              <summary>view</summary>
              <pre style="white-space: pre-wrap;">{{ r.variables | tojson(indent=2) }}</pre>
            </details>
          {% endif %}
        </td>
        <td>
          {{r.status}}
          {% if r.variables_delta %}
            <details>
              <summary>delta</summary>
              <pre style="white-space: pre-wrap;">{{ r.variables_delta | tojson(indent=2) }}</pre>
            </details>
          {% endif %}
        </td>
        <td>{% if r.error_type %}{{r.error_type}}: {{r.error_message}}{% endif %}</td>
        <td>{{r.timestamp}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <script>
    (function() {
      const state = {
        showLibs: false,
        showScalarsFirst: true,
        expandLong: false,
        maxPreview: 120
      };

      function isObject(value) {
        return value && typeof value === 'object' && !Array.isArray(value);
      }

      function renderValue(value) {
        if (isObject(value)) return JSON.stringify(value);
        return String(value);
      }

      function isLikelyLibOrType(key, valueStr) {
        if (state.showLibs) return false;
        const k = (key || '').toString();
        const v = (valueStr || '').toString();
        if (/^__.*__$/.test(k)) return true; // dunder vars
        if (/^<module\s/.test(v)) return true;
        if (/^<class\s/.test(v)) return true;
        if (/^<function\s/.test(v)) return true;
        if (v.includes('typing.')) return true;
        if (v.includes("from '/") && v.includes('site-packages')) return true;
        if (/^<.* at 0x[0-9a-fA-F]+>$/.test(v)) return true;
        return false;
      }

      function isScalar(value) {
        return (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean');
      }

      function truncate(text, limit) {
        const t = String(text);
        if (state.expandLong) return t;
        if (t.length <= limit) return t;
        return t.slice(0, limit - 1) + '…';
      }

      function getPath(obj, path) {
        try {
          return path.reduce((acc, k) => (acc == null ? undefined : acc[k]), obj);
        } catch { return undefined; }
      }

      function collectFlatChanges(varsByScope, deltaByScope) {
        const results = [];
        const scopeNames = Array.from(new Set([...Object.keys(varsByScope||{}), ...Object.keys(deltaByScope||{})]));
        for (const scopeName of scopeNames) {
          const varsObj = (varsByScope && varsByScope[scopeName]) || {};
          const deltaObj = (deltaByScope && deltaByScope[scopeName]) || {};
          function walk(deltaNode, path) {
            for (const key of Object.keys(deltaNode)) {
              const val = deltaNode[key];
              const newPath = path.concat([key]);
              if (isObject(val)) {
                walk(val, newPath);
              } else {
                const currentVal = getPath(varsObj, newPath);
                results.push({ scopeName, keyPath: newPath, key: newPath.join('.'), value: currentVal, kind: (currentVal === undefined || currentVal === null) ? 'removed' : 'changed' });
              }
            }
          }
          walk(deltaObj, []);
        }
        return results;
      }

      function renderHighlights(variables, delta) {
        const container = document.getElementById('highlights');
        container.innerHTML = '';
        const changes = collectFlatChanges(variables, delta);
        if (changes.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'faded';
          empty.textContent = 'No changes.';
          container.appendChild(empty);
          return;
        }
        // Prefer scalars; limit to 8
        const preferred = changes.sort((a,b) => {
          const av = a.value, bv = b.value;
          const as = isScalar(av) ? 0 : 1;
          const bs = isScalar(bv) ? 0 : 1;
          return as - bs || a.key.length - b.key.length;
        }).slice(0, 8);
        for (const c of preferred) {
          const chip = document.createElement('div');
          chip.className = 'chip ' + (c.kind === 'removed' ? 'removed' : 'changed');
          chip.title = `${c.scopeName} · ${c.key}`;
          const keyEl = document.createElement('span');
          keyEl.className = 'key';
          keyEl.textContent = c.key.split('.').slice(-1)[0] + ':';
          const valEl = document.createElement('span');
          valEl.className = 'val';
          const valText = isObject(c.value) ? '{…}' : renderValue(c.value);
          valEl.textContent = truncate(valText, state.maxPreview);
          chip.appendChild(keyEl);
          chip.appendChild(valEl);
          container.appendChild(chip);
        }
      }

      function buildVarTree(scopeName, dataObj, deltaObj) {
        const card = document.createElement('div');
        card.className = 'scope-card';
        const title = document.createElement('div');
        title.className = 'scope-name';
        title.textContent = scopeName;
        card.appendChild(title);

        const list = document.createElement('ul');
        list.className = 'var-list';

        // Filter and sort keys: scalars first when enabled
        const keysRaw = Object.keys(dataObj || {});
        const keys = keysRaw.filter(k => !isLikelyLibOrType(k, renderValue(dataObj[k]))).sort((a,b) => {
          if (!state.showScalarsFirst) return a.localeCompare(b);
          const as = isScalar(dataObj[a]) ? 0 : 1;
          const bs = isScalar(dataObj[b]) ? 0 : 1;
          return as - bs || a.localeCompare(b);
        });
        const deltaKeys = Object.keys(deltaObj || {});
        const allKeys = Array.from(new Set([...keys, ...deltaKeys])).sort();

        for (const key of allKeys) {
          const value = dataObj ? dataObj[key] : undefined;
          const delta = deltaObj ? deltaObj[key] : undefined;

          const li = document.createElement('li');
          li.className = 'var-item';

          const label = document.createElement('div');
          const keyEl = document.createElement('span');
          keyEl.className = 'var-key';
          keyEl.textContent = key;
          label.appendChild(keyEl);

          if (delta !== undefined) {
            const badge = document.createElement('span');
            if (delta === null || delta === undefined) {
              badge.className = 'badge badge-removed';
              badge.textContent = 'removed';
            } else if (isObject(delta)) {
              badge.className = 'badge badge-changed';
              badge.textContent = 'modified';
            } else {
              badge.className = 'badge badge-changed';
              // Heuristic: treat as added/changed
              badge.textContent = (key in (dataObj || {})) ? 'changed' : 'added';
            }
            label.appendChild(badge);
          } else {
            label.classList.add('faded');
          }

          li.appendChild(label);

          const val = document.createElement('div');
          val.className = 'var-val';

          if (isObject(value)) {
            // Summarize nested object
            const summary = document.createElement('div');
            const keysCount = Object.keys(value || {}).length;
            summary.textContent = `{object · ${keysCount} keys}`;
            summary.className = 'faded';
            const details = document.createElement('details');
            const summaryEl = document.createElement('summary');
            summaryEl.textContent = 'expand';
            details.appendChild(summaryEl);
            details.appendChild(buildNestedList(value, isObject(delta) ? delta : {}));
            val.appendChild(summary);
            val.appendChild(details);
          } else {
            const text = renderValue(value);
            const span = document.createElement('span');
            span.textContent = truncate(text, state.maxPreview);
            span.title = text;
            val.appendChild(span);
          }
          li.appendChild(val);
          list.appendChild(li);
        }

        card.appendChild(list);
        return card;
      }

      function buildNestedList(obj, delta) {
        const innerList = document.createElement('ul');
        innerList.className = 'var-list';
        const keys = Object.keys(obj || {}).sort();
        const deltaKeys = Object.keys(delta || {});
        const allKeys = Array.from(new Set([...keys, ...deltaKeys])).sort();
        for (const key of allKeys) {
          const val = obj ? obj[key] : undefined;
          const d = delta ? delta[key] : undefined;

          const li = document.createElement('li');
          li.className = 'var-item';
          const header = document.createElement('div');
          const k = document.createElement('span');
          k.className = 'var-key';
          k.textContent = key;
          header.appendChild(k);

          if (d !== undefined) {
            const badge = document.createElement('span');
            if (d === null || d === undefined) {
              badge.className = 'badge badge-removed';
              badge.textContent = 'removed';
            } else if (isObject(d)) {
              badge.className = 'badge badge-changed';
              badge.textContent = 'modified';
            } else {
              badge.className = 'badge badge-changed';
              badge.textContent = (key in (obj || {})) ? 'changed' : 'added';
            }
            header.appendChild(badge);
          } else {
            header.classList.add('faded');
          }

          li.appendChild(header);
          const valEl = document.createElement('div');
          valEl.className = 'var-val';
          if (isObject(val)) {
            valEl.appendChild(buildNestedList(val, isObject(d) ? d : {}));
          } else {
            valEl.textContent = renderValue(val);
          }
          li.appendChild(valEl);
          innerList.appendChild(li);
        }
        return innerList;
      }

      function renderVisualizer(row) {
        const viz = document.getElementById('visualizer');
        const vizMeta = document.getElementById('viz-meta');
        if (!row) {
          viz.innerHTML = '<div class="faded" style="font-size:13px;">Awaiting selection…</div>';
          vizMeta.textContent = 'No row selected. Click a row below to visualize scope changes.';
          return;
        }

        // Meta panel
        const file = row.dataset.file;
        const line = row.dataset.line;
        const code = row.dataset.code;
        const status = row.dataset.status;
        vizMeta.innerHTML = '';
        const parts = [
          `<span><strong>File:</strong> <code>${file}</code></span>`,
          `<span><strong>Line:</strong> ${line}</span>`,
          `<span><strong>Status:</strong> ${status}</span>`,
        ];
        const codeEl = document.createElement('div');
        codeEl.style.marginTop = '6px';
        codeEl.innerHTML = `<code>${code}</code>`;
        vizMeta.innerHTML = parts.join(' \u2022 ');
        vizMeta.appendChild(codeEl);

        // Visualizer grid of scopes
        viz.innerHTML = '';
        const currentLineBanner = document.getElementById('current-line');
        if (currentLineBanner) {
          currentLineBanner.innerHTML = '';
          const pathEl = document.createElement('div');
          pathEl.className = 'path';
          const func = row.dataset.func;
          pathEl.textContent = func ? `${file}:${line} — ${func}()` : `${file}:${line}`;
          pathEl.title = `${file}:${line}`;
          const codeEl2 = document.createElement('div');
          codeEl2.className = 'code';
          codeEl2.textContent = code;
          currentLineBanner.appendChild(pathEl);
          currentLineBanner.appendChild(codeEl2);
        }
        const scopesGrid = document.createElement('div');
        scopesGrid.className = 'scopes-grid';

        let variables, delta;
        try {
          variables = JSON.parse(row.dataset.variables || '{}');
        } catch { variables = {}; }
        try {
          delta = JSON.parse(row.dataset.delta || '{}');
        } catch { delta = {}; }

        // Quick highlights from delta
        renderHighlights(variables, delta);

        const scopeNames = Array.from(new Set([...Object.keys(variables || {}), ...Object.keys(delta || {})])).sort();
        if (scopeNames.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'faded';
          empty.textContent = 'No variables captured.';
          viz.appendChild(empty);
          return;
        }

        for (const scopeName of scopeNames) {
          const sVars = variables ? variables[scopeName] : undefined;
          const sDelta = delta ? delta[scopeName] : undefined;
          scopesGrid.appendChild(buildVarTree(scopeName, sVars || {}, sDelta || {}));
        }

        viz.appendChild(scopesGrid);
      }

      // Hook up table row clicks
      const tbody = document.querySelector('tbody');
      const tableContainer = document.querySelector('.table-container');
      if (!tbody) return;
      let selected = null;
      let rows = Array.from(tbody.querySelectorAll('tr'));
      function updateStepperStatus() {
        if (!selected) { document.getElementById('stepper-status').textContent = ''; return; }
        const idx = rows.indexOf(selected);
        if (idx >= 0) document.getElementById('stepper-status').textContent = `Row ${idx+1} of ${rows.length}`;
      }
      function selectRow(tr) {
        if (!tr) return;
        if (selected) selected.classList.remove('selected');
        selected = tr;
        tr.classList.add('selected');
        // Keep selection visible within the table container without moving the whole page
        if (tableContainer) {
          const rowTop = tr.offsetTop;
          const rowBottom = rowTop + tr.offsetHeight;
          const viewTop = tableContainer.scrollTop;
          const viewBottom = viewTop + tableContainer.clientHeight;
          const padding = 24;
          if (rowTop < viewTop) {
            tableContainer.scrollTo({ top: Math.max(0, rowTop - padding), behavior: 'smooth' });
          } else if (rowBottom > viewBottom) {
            tableContainer.scrollTo({ top: rowBottom - tableContainer.clientHeight + padding, behavior: 'smooth' });
          }
        }
        renderVisualizer(tr);
        updateStepperStatus();
      }
      tbody.addEventListener('click', function(e) {
        const tr = e.target && (e.target.closest('tr'));
        if (!tr) return;
        selectRow(tr);
      });

      // Option toggles
      const optLibs = document.getElementById('opt-show-libs');
      const optScalars = document.getElementById('opt-show-scalars');
      const optLong = document.getElementById('opt-show-long');
      function rerender() { if (selected) renderVisualizer(selected); }
      optLibs.addEventListener('click', () => { state.showLibs = !state.showLibs; optLibs.classList.toggle('active', state.showLibs); rerender(); });
      optScalars.addEventListener('click', () => { state.showScalarsFirst = !state.showScalarsFirst; optScalars.classList.toggle('active', state.showScalarsFirst); rerender(); });
      optLong.addEventListener('click', () => { state.expandLong = !state.expandLong; optLong.classList.toggle('active', state.expandLong); rerender(); });

      // Auto-select the first row if present
      const first = tbody.querySelector('tr');
      if (first) selectRow(first);

      // Stepper controls
      const btnPrev = document.getElementById('step-prev');
      const btnNext = document.getElementById('step-next');
      btnPrev.addEventListener('click', () => {
        if (!selected) return;
        const idx = rows.indexOf(selected);
        if (idx > 0) selectRow(rows[idx-1]);
      });
      btnNext.addEventListener('click', () => {
        if (!selected) return;
        const idx = rows.indexOf(selected);
        if (idx < rows.length - 1) selectRow(rows[idx+1]);
      });

      // Keep rows array in sync if table updates
      const observer = new MutationObserver(() => { rows = Array.from(tbody.querySelectorAll('tr')); updateStepperStatus(); });
      observer.observe(tbody, { childList: true, subtree: false });
    })();
  </script>
</body>
</html>
